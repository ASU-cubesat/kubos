machine:
  services:
    - docker

dependencies:
  override:
    - docker pull kubos/kubos-dev:latest
    - if [ $CIRCLE_BRANCH = 'auto-docs' ]; then docker pull kubos/kubos-docs:latest; fi

test:
  override:
      - docker run -t --env CIRCLE_BRANCH=$CIRCLE_BRANCH -v $PWD:$PWD kubos/kubos-dev:latest python $PWD/test/integration/integration_test.py
      - docker run -t --env CIRCLE_BRANCH=$CIRCLE_BRANCH --env CIRCLE_ARTIFACTS=$CIRCLE_ARTIFACTS -v $PWD:$PWD -v $CIRCLE_ARTIFACTS:$CIRCLE_ARTIFACTS --workdir $PWD kubos/kubos-dev:latest python -m tools.ci.lint
      - docker run -t --env CIRCLE_BRANCH=$CIRCLE_BRANCH -v $PWD:$PWD kubos/kubos-dev:latest /sbin/my_init -- python $PWD/tools/build.py --all-tests

deployment:
  production:
    branch: auto-docs
    commands:
      - ./deploy.sh
      - docker run -t -v $PWD:$PWD --workdir $PWD kubos/kubos-docs:latest sh prep_docs.sh
      - ./deploy_docs.sh
